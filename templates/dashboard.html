<!DOCTYPE html> 
<html lang="{{ lang }}"> 
<head> 
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8"> 
  <title>{{ t.dashboard_title }}</title> 

  <link rel="stylesheet" href="/static/dashboard.css"> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script> 
</head>
<body> 

  <!-- Top Navbar -->
  <nav class="navbar"> 
    <div class="user-icon"> 
      {% if 'username' in session %} 
      <a href="{{ url_for('profile', username=session['username']) }}" class="nav-profile-icon"> <!-- Link to user's profile -->
        <img
          src="{{ url_for('static', filename='uploads/' ~ (session.get('avatar') if session.get('avatar') else 'default.png')) }}"
 
          class="nav-avatar" 
          alt="{{ t.alt_profile }}">
      </a>
      {% else %} 
      <a href="{{ url_for('profile', username=session['username']) }}"> 
        <img src="/static/menu_images/User.png" alt="{{ t.alt_user }}" /> 
      </a>
      {% endif %} 
    </div>

    <div class="theme-toggle-icon" onclick="toggleTheme()"> 
      ğŸŒ“ 
    </div>
  </nav>

  <!-- Export button -->
  <button id="export-btn" class="export-btn">{{ t.export_pdf }}</button> <!-- Button to open PDF modal/export (translated label) -->

  <!-- Title + loading message -->
  <h2 class="stats-title">{{ t.game_stats_title }}</h2> <!-- Main stats title (translated) -->
  <p id="loading-message" class="stats-title">{{ t.waiting_for_stats }}</p> <!-- Loading message shown until stats are loaded -->

  <!-- STATS TABLE FOR SCREEN (LIVE TABLE) -->
  <div class="stats-table-wrapper"> <!-- Wrapper used for table layout/scroll -->
    <table class="stats-table" border="1" cellpadding="5" cellspacing="0" width="100%"> <!-- Stats table structure -->
      <thead> 
        <tr> 
          <th>{{ t.col_name }}</th> <!-- Column: username (translated) -->
          <th>{{ t.col_age }}</th> <!-- Column: age (translated) -->
          <th>{{ t.col_game }}</th> <!-- Column: game name (translated label; values come from API) -->
          <th>{{ t.col_score }}</th> <!-- Column: score (translated) -->
          <th>{{ t.col_time_seconds }}</th> <!-- Column: time in seconds (translated) -->
          <th>{{ t.col_result }}</th> <!-- Column: result (translated) -->
          <th>{{ t.col_date }}</th> <!-- Column: date/time (translated) -->
        </tr>
      </thead>

      <tbody id="stats-body"> <!-- Body that will be replaced by JS live updates -->
        {% for s in stats %} <!-- Server-side rendering of initial stats rows (optional, before JS refresh) -->
        <tr> <!-- One stats row -->
          <td>{{ s.username }}</td> <!-- Username value -->
          <td>{{ s.age }}</td> <!-- Age value -->
          <td>{{ s.game_name }}</td> <!-- Game name (already mapped by backend to selected language) -->
          <td>{{ s.score }}</td> <!-- Score value -->
          <td>{{ s.time_seconds }}</td> <!-- Time in seconds -->
          <td>{{ s.result }}</td> <!-- Result (already mapped by backend to selected language) -->
          <td>{{ s.created_at }}</td> <!-- Creation timestamp (raw; JS later formats locale) -->
        </tr>
        {% endfor %} 
      </tbody>
    </table>
  </div>

  <!-- Modal: user details before creating the PDF -->
  <div id="pdf-modal" class="pdf-modal hidden">
    <div class="pdf-modal-content">
      <h3>{{ t.patient_details }}</h3> <!-- Modal title (translated) -->
      <p>{{ t.fill_details_for_pdf }}</p> <!-- Modal instructions (translated) -->

      <form id="pdf-form"> 
        <label> 
          {{ t.first_name }}: <!-- First name label (translated) -->
          <input type="text" id="pdf-firstname" required> <!-- Input for first name -->
        </label>

        <label> 
          {{ t.last_name }}: 
          <input type="text" id="pdf-lastname" required> 
        </label>

        <div class="pdf-modal-actions"> 
          <button type="button" id="pdf-cancel">{{ t.cancel }}</button> <!-- Cancel button closes modal (translated) -->
          <button type="submit" id="pdf-submit">{{ t.create_pdf }}</button> <!-- Submit button triggers PDF generation (translated) -->
        </div>
      </form>
    </div>
  </div>

  <!-- TheraHand Chat Bot Widget -->
  <div id="thera-bot-widget"> 
    <button id="thera-bot-toggle" class="bot-toggle-btn" aria-label="{{ t.bot_open_chat_aria }}"> <!-- Button to open chat; aria label translated -->
      ğŸ’¬ <!-- Chat icon -->
    </button>

    <div id="thera-bot-window" class="bot-window bot-hidden"> 
      <div class="bot-header">
        <div class="bot-header-info"> 
          <div class="bot-avatar">TH</div> 
          <div>
            <div class="bot-title">TheraHand Bot</div> 
            <div class="bot-status">ğŸŸ¢ {{ t.bot_available }}</div> <!-- Availability label (translated) -->
          </div>
        </div>
        <button class="bot-close-btn" id="thera-bot-close" aria-label="{{ t.close }}">âœ•</button> <!-- Close button; aria label translated -->
      </div>

      <div class="bot-messages" id="thera-bot-messages"></div> 

      <div class="bot-input-bar"> 
        <button id="thera-bot-voice" class="bot-voice-btn" title="{{ t.voice_message }}">ğŸ¤</button> <!-- Voice button with translated tooltip -->
        <input id="thera-bot-input" type="text" placeholder="{{ t.type_your_message }}" autocomplete="off"> <!-- Text input with translated placeholder -->
        <button id="thera-bot-send" class="bot-send-btn" aria-label="{{ t.send }}">â¤</button> <!-- Send button with aria label translated -->
      </div>
      <div class="bot-voice-status" id="thera-bot-voice-status"></div> <!-- Voice status text area -->
    </div>
  </div>

  <!-- Bottom Navbar -->
  <footer class="bottom-navbar"> 
    <a href="/today" class="nav-item"> 
      <img src="/static/menu_images/planning.png" alt="{{ t.today }}"> 
      <span>{{ t.today }}</span> 
    </a>
    <a href="{{ url_for('dashboard') }}" class="nav-item"> 
      <img src="/static/menu_images/statistic.png" alt="{{ t.stats }}"> 
      <span>{{ t.stats }}</span> 
    </a>
    <a href="{{ url_for('menu') }}" class="nav-item"> 
      <img src="/static/menu_images/games.png" alt="{{ t.games }}">
      <span>{{ t.games }}</span> 
    </a>
  </footer>

  <!-- Pass translations into JS (so JS can display translated messages) -->
  <script>
    window.I18N = { // Global object holding translations for JavaScript usage
      lang: "{{ lang }}", // Current language code from server
      updating_stats: "{{ t.updating_stats }}", // Message shown while refreshing stats
      no_stats_yet: "{{ t.no_stats_yet }}", // Message shown if no stats exist
      stats_load_failed: "{{ t.stats_load_failed }}", // Message shown if API fails
      no_stats_for_export: "{{ t.no_stats_for_export }}", // Alert if export requested with no stats
      pdf_filename: "{{ t.pdf_filename }}", // Filename for generated PDF
      report_title: "{{ t.pdf_report_title }}", // PDF report title
      report_date_label: "{{ t.report_date_label }}", // Label for report date
      results_title: "{{ t.pdf_results_title }}", // Section title for results
      label_score: "{{ t.label_score }}", // Label for score
      label_time: "{{ t.label_time }}", // Label for time
      label_result: "{{ t.label_result }}", // Label for result
      label_age: "{{ t.label_age }}", // Label for age
      label_first_name: "{{ t.first_name }}", // Label for first name
      label_last_name: "{{ t.last_name }}" // Label for last name
    };
  </script>

  <script>
    // ============= LIVE STATS TABLE (AUTO-REFRESH) =============

    async function updateStats() { // Fetch latest stats and update the table UI
      const message = document.getElementById("loading-message"); // Loading/status message element
      const tbody   = document.getElementById("stats-body"); // Table body that will be filled with rows

      const locale = (window.I18N.lang === "en") ? "en-US" : "el-GR"; // Choose locale for date formatting

      try { // Try to fetch and render stats
        message.textContent = window.I18N.updating_stats; // Show "updating" message

        const response = await fetch("/api/stats"); // Call backend endpoint that returns stats JSON
        const data     = await response.json(); // Parse JSON payload

        window.latestStats = data; // Store latest stats globally for PDF export reuse

        if (!data || data.length === 0) { // If no stats returned...
          message.textContent = window.I18N.no_stats_yet; // Show "no stats" message
          tbody.innerHTML = ""; // Clear table rows
          return; // Stop rendering
        }

        message.textContent = ""; // Clear loading/status message
        tbody.innerHTML = ""; // Clear existing rows

        data.forEach(s => { // For each stats record...
          const dateStr = new Date(s.created_at).toLocaleString(locale); // Convert timestamp to localized string
          const row = ` 
            <tr>
              <td>${s.username}</td>
              <td>${s.age}</td>
              <td>${s.game_name}</td>
              <td>${s.score}</td>
              <td>${s.time_seconds}</td>
              <td>${s.result}</td>
              <td>${dateStr}</td>
            </tr>
          `; // Build HTML row (game_name/result already translated by backend)
          tbody.innerHTML += row; // Append row into table body
        });

      } catch (error) { // If something fails (network, parsing, etc.)
        console.error("âŒ Stats update error:", error); // Log error to console
        message.textContent = window.I18N.stats_load_failed; // Show translated error message
      }
    }

    setInterval(updateStats, 15000); // Refresh stats every 15 seconds
    updateStats(); // Initial fetch immediately on load

    // ============= CHECK IF STATS EXIST TO SHOW/HIDE EXPORT BUTTON =============
    function checkIfStatsExist() { // Fetch stats and show export button only if there are rows
      fetch("/api/stats") // Call stats endpoint
        .then(res => res.json()) // Parse JSON
        .then(data => { // Handle stats data
          const btn = document.getElementById("export-btn"); // Export button element
          btn.style.display = (data.length > 0) ? "block" : "none"; // Show if any stats exist
        });
    }

    checkIfStatsExist(); // Run once on load
    setInterval(checkIfStatsExist, 15000); // Repeat every 15 seconds

    // =================== PDF â€“ Modal + Export ===================
    const exportBtn  = document.getElementById("export-btn"); // Export button reference
    const pdfModal   = document.getElementById("pdf-modal"); // Modal overlay reference
    const pdfForm    = document.getElementById("pdf-form"); // Form inside modal
    const pdfCancel  = document.getElementById("pdf-cancel"); // Cancel button inside modal
    const pdfFirst   = document.getElementById("pdf-firstname"); // First name input
    const pdfLast    = document.getElementById("pdf-lastname"); // Last name input

    exportBtn.addEventListener("click", () => { // When export button clicked...
      pdfFirst.value = localStorage.getItem("pdf_firstName") || ""; // Prefill first name from localStorage
      pdfLast.value  = localStorage.getItem("pdf_lastName")  || ""; // Prefill last name from localStorage
      pdfModal.classList.remove("hidden"); // Show modal
    });

    pdfCancel.addEventListener("click", () => { // When cancel clicked...
      pdfModal.classList.add("hidden"); // Hide modal
    });

    pdfForm.addEventListener("submit", async (e) => { // When modal form submitted...
      e.preventDefault(); // Prevent normal form submission

      const firstName = pdfFirst.value.trim(); // Read first name
      const lastName  = pdfLast.value.trim(); // Read last name
      if (!firstName || !lastName) return; // Require both fields

      localStorage.setItem("pdf_firstName", firstName); // Save first name for next time
      localStorage.setItem("pdf_lastName", lastName); // Save last name for next time

      pdfModal.classList.add("hidden"); // Hide modal
      await generatePDF(firstName, lastName); // Generate PDF using inputs
    });

    async function generatePDF(firstName, lastName) { // Generate PDF from stats
      let stats = window.latestStats; // Use cached stats if available

      if (!stats) { // If no cached stats...
        const res = await fetch("/api/stats"); // Fetch from API
        stats = await res.json(); // Parse JSON
        window.latestStats = stats; // Cache it
      }

      if (!stats || stats.length === 0) { // If still no stats...
        alert(window.I18N.no_stats_for_export); // Alert translated message
        return; // Stop
      }

      const tempWrapper = document.createElement("div"); // Create temporary DOM container for PDF HTML
      tempWrapper.id = "pdf-temp-wrapper"; // Give it an id
      tempWrapper.innerHTML = buildReportHTML(stats, firstName, lastName); // Inject report HTML

      document.body.appendChild(tempWrapper); // Add to DOM so html2pdf can render it
      preparePDF(tempWrapper); // Apply PDF-specific styling tweaks

      const options = { // html2pdf options
        margin: 10, // PDF margin
        filename: window.I18N.pdf_filename, // Output PDF filename (translated)
        image: { type: "jpeg", quality: 1 }, // Image quality for PDF render
        html2canvas: { scale: 2 }, // Render scale for sharper PDF
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" } // PDF size and orientation
      };

      await html2pdf().set(options).from(tempWrapper).save(); // Render and save PDF
      document.body.removeChild(tempWrapper); // Remove temporary container from DOM
    }

    function escapeHTML(str){ // Escape any string to avoid HTML injection in generated PDF
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function calculateSummary(stats) {
  const totalSessions = stats.length;

  const exercises = new Set(stats.map(s => s.game_name));
  const totalExercises = exercises.size;

  const successResults = ["Win", "Completed", "Success"];
  const successful = stats.filter(s =>
    successResults.some(r => s.result.includes(r))
  ).length;

  const successRate = totalSessions
    ? Math.round((successful / totalSessions) * 100)
    : 0;

  const times = stats
    .map(s => Number(s.time_seconds))
    .filter(t => t > 0);

  const avgTime = times.length
    ? Math.round(times.reduce((a, b) => a + b, 0) / times.length)
    : "â€”";

  const perExercise = {};
  stats.forEach(s => {
    perExercise[s.game_name] ??= { ok: 0, total: 0 };
    perExercise[s.game_name].total++;
    if (successResults.some(r => s.result.includes(r))) {
      perExercise[s.game_name].ok++;
    }
  });

  let bestExercise = "â€”";
  let bestRate = 0;
  Object.entries(perExercise).forEach(([name, v]) => {
    const rate = v.ok / v.total;
    if (rate > bestRate) {
      bestRate = rate;
      bestExercise = name;
    }
  });

  let progress = "Stable";
  if (successRate >= 70) progress = "Improving";
  if (successRate >= 85) progress = "Excellent";

  return {
    totalSessions,
    totalExercises,
    successRate,
    avgTime,
    bestExercise,
    progress
  };
}


    function buildReportHTML(stats, firstName, lastName) {
  const grouped = new Map();
  stats.forEach(s => {
    if (!grouped.has(s.game_name)) grouped.set(s.game_name, []);
    grouped.get(s.game_name).push(s);
  });

  const locale = (window.I18N.lang === "en") ? "en-US" : "el-GR";
  const today  = new Date().toLocaleDateString(locale);

  // âœ… compute summary BEFORE building HTML
  const summary = calculateSummary(stats);

  let html = `
    <div class="pdf-report">
      <h1 class="pdf-title">${escapeHTML(window.I18N.report_title)}</h1>

      <div class="pdf-patient-info">
        <div><strong>${escapeHTML(window.I18N.label_first_name)}:</strong> ${escapeHTML(firstName)}</div>
        <div><strong>${escapeHTML(window.I18N.label_last_name)}:</strong> ${escapeHTML(lastName)}</div>
        <div><strong>${escapeHTML(window.I18N.report_date_label)}:</strong> ${escapeHTML(today)}</div>
      </div>

      <!-- âœ… SUMMARY BOX -->
      <div class="pdf-summary">
        <h2 class="pdf-summary-title">${window.I18N.lang === "en" ? "Summary" : "Î£ÏÎ½Î¿ÏˆÎ·"}</h2>
        <ul class="pdf-summary-list">
          <li><strong>${window.I18N.lang === "en" ? "Total sessions" : "Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚"}:</strong> ${summary.totalSessions}</li>
          <li><strong>${window.I18N.lang === "en" ? "Exercises performed" : "Î‘ÏƒÎºÎ®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Î·ÎºÎ±Î½"}:</strong> ${summary.totalExercises}</li>
          <li><strong>${window.I18N.lang === "en" ? "Success rate" : "Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚"}:</strong> ${summary.successRate}%</li>
          <li><strong>${window.I18N.lang === "en" ? "Average time" : "ÎœÎ­ÏƒÎ¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚"}:</strong> ${summary.avgTime} ${summary.avgTime === "â€”" ? "" : "sec"}</li>
          <li><strong>${window.I18N.lang === "en" ? "Best performance" : "ÎšÎ±Î»ÏÏ„ÎµÏÎ· ÎµÏ€Î¯Î´Î¿ÏƒÎ·"}:</strong> ${escapeHTML(summary.bestExercise)}</li>
          <li><strong>${window.I18N.lang === "en" ? "Overall progress" : "Î“ÎµÎ½Î¹ÎºÎ® Ï€ÏÏŒÎ¿Î´Î¿Ï‚"}:</strong> ${escapeHTML(summary.progress)}</li>
        </ul>
      </div>

      <hr class="pdf-divider">

      <h2 class="pdf-section-title">${escapeHTML(window.I18N.results_title)}</h2>
  `;

  grouped.forEach((rows, gameName) => {
    html += `
      <section class="pdf-game-section">
        <h3 class="pdf-game-title">${escapeHTML(gameName)}</h3>
    `;

    rows.forEach((s, index) => {
      const dateStr = new Date(s.created_at).toLocaleString(locale);
      html += `
        <div class="pdf-result-card">
          <div class="pdf-result-header">
            <span class="pdf-result-index">#${rows.length - index}</span>
            <span class="pdf-result-date">${escapeHTML(dateStr)}</span>
          </div>
          <div class="pdf-result-body">
            <div><strong>${escapeHTML(window.I18N.label_score)}:</strong> ${escapeHTML(s.score)}</div>
            <div><strong>${escapeHTML(window.I18N.label_time)}:</strong> ${escapeHTML(s.time_seconds)} sec</div>
            <div><strong>${escapeHTML(window.I18N.label_result)}:</strong> ${escapeHTML(s.result)}</div>
            <div><strong>${escapeHTML(window.I18N.label_age)}:</strong> ${escapeHTML(s.age)}</div>
          </div>
        </div>
      `;
    });

    html += `</section>`;
  });

  html += `</div>`;
  return html;
}
function preparePDF(wrapper) {
  wrapper.style.background = "white";
  wrapper.style.color = "#222";
  wrapper.style.fontSize = "14px";
  wrapper.style.padding = "20px";

  // âœ… style the summary box (in case dashboard.css is not applied to the temp wrapper)
  const summaryBox = wrapper.querySelector(".pdf-summary");
  if (summaryBox) {
    summaryBox.style.background = "#f4f6f8";
    summaryBox.style.padding = "12px";
    summaryBox.style.borderRadius = "10px";
    summaryBox.style.margin = "14px 0 18px";
  }

  const summaryTitle = wrapper.querySelector(".pdf-summary-title");
  if (summaryTitle) {
    summaryTitle.style.margin = "0 0 8px";
    summaryTitle.style.fontSize = "18px";
  }

  const summaryList = wrapper.querySelector(".pdf-summary-list");
  if (summaryList) {
    summaryList.style.margin = "0";
    summaryList.style.paddingLeft = "18px";
  }
}

  </script>

  <script src="{{ url_for('static', filename='chatbot.js') }}"></script> 
  <script src="/static/theme.js"></script> 
</body> 
</html> 
